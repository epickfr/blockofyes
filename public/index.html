<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Epick Chat</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{
  --bg: #0a0a0f;
  --panel: rgba(17, 17, 27, 0.4);
  --muted: rgba(255, 255, 255, 0.6);
  --accent: #a78bfa;
  --accent-glow: rgba(167, 139, 250, 0.15);
  --glass-border: rgba(255, 255, 255, 0.1);
}
*{box-sizing:border-box;margin:0}
body{
  font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
  background: #0a0a0f;
  color: #f5f5f7;
  min-height: 100vh;
}
.navbar{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: rgba(17, 17, 27, 0.3);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--glass-border);
}
.brand{
  font-weight: 800;
  color: var(--accent);
  font-size: 18px;
  text-shadow: 0 0 20px var(--accent-glow);
}
.nav-actions{display:flex;gap:8px;align-items:center}
.inbox-btn{
  position: relative;
  padding: 8px 12px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s ease;
}
.inbox-btn:hover{
  background: rgba(255, 255, 255, 0.08);
  border-color: var(--accent);
  box-shadow: 0 0 20px var(--accent-glow);
}
.inbox-badge{
  position: absolute;
  top: -6px;
  right: -6px;
  background: var(--accent);
  color: #0a0a0f;
  padding: 2px 6px;
  border-radius: 999px;
  font-weight: 700;
  font-size: 12px;
  box-shadow: 0 0 15px var(--accent-glow);
}
.tabs{display:flex;gap:8px;margin:16px 12px}
.tab{
  padding: 10px 12px;
  border-radius: 10px;
  background: transparent;
  cursor: pointer;
  color: var(--muted);
  transition: all 0.2s ease;
  border: 1px solid transparent;
}
.tab:hover{
  background: rgba(255, 255, 255, 0.03);
  border-color: rgba(255, 255, 255, 0.05);
}
.tab.active{
  background: rgba(167, 139, 250, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(167, 139, 250, 0.2);
  color: #fff;
  box-shadow: 0 0 20px var(--accent-glow);
}
main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:6px 18px 24px}
.panel{
  background: rgba(17, 17, 27, 0.4);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 16px;
  min-height: 64vh;
  display: none;
  flex-direction: column;
  gap: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}
.panel.active{display:flex}
.list{display:flex;flex-direction:column;gap:8px;max-height:56vh;overflow:auto;padding-right:6px}
.list-item{
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.05);
  cursor: pointer;
  transition: all 0.2s ease;
}
.list-item:hover{
  transform: translateY(-2px);
  background: rgba(255, 255, 255, 0.06);
  border-color: var(--accent);
  box-shadow: 0 4px 20px var(--accent-glow);
}
.pfp{
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--glass-border);
}
.room-pfp{
  width: 44px;
  height: 44px;
  border-radius: 10px;
  object-fit: cover;
  border: 2px solid var(--glass-border);
  margin-right: 12px;
}
.card-title{font-weight:700;margin-bottom:8px;color:#fff}
.room-meta{font-size:12px;color:var(--muted);margin-top:4px}
.chat-overlay{
  position: fixed;
  inset: 0;
  background: rgba(10, 10, 15, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  display: flex;
  flex-direction: column;
  z-index: 1200;
  align-items: center;
  justify-content: center;
}
.chat-overlay.hidden{display:none}
.chat-window{
  width: 92%;
  max-width: 1100px;
  height: 84%;
  background: rgba(17, 17, 27, 0.5);
  backdrop-filter: blur(40px);
  -webkit-backdrop-filter: blur(40px);
  display: flex;
  flex-direction: column;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--glass-border);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
}
.chat-header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  background: rgba(255, 255, 255, 0.03);
  border-bottom: 1px solid var(--glass-border);
}
.chat-title{display:flex;align-items:center;gap:12px;font-weight:700;color:#fff}
.chat-messages{
  flex: 1;
  padding: 18px;
  overflow: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: rgba(0, 0, 0, 0.1);
}
.chat-input{
  display: flex;
  gap: 8px;
  padding: 12px;
  border-top: 1px solid var(--glass-border);
  background: rgba(255, 255, 255, 0.02);
}
.chat-input input{
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: #fff;
  border: 1px solid var(--glass-border);
  transition: all 0.2s ease;
}
.chat-input input:focus{
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 20px var(--accent-glow);
}
.chat-message{display:flex;gap:12px;align-items:flex-start}
.chat-message .bubble{
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  padding: 10px 14px;
  border-radius: 12px;
  max-width: 78%;
}
.chat-message.me .bubble{
  background: rgba(167, 139, 250, 0.15);
  border-color: rgba(167, 139, 250, 0.3);
  align-self: flex-end;
}
.bubble .meta{font-size:12px;color:var(--muted);cursor:pointer}
.bubble .actions{margin-top:8px;font-size:12px;display:flex;gap:8px;color:var(--muted);cursor:pointer}
.btn{
  padding: 8px 16px;
  border-radius: 10px;
  border: none;
  background: var(--accent);
  color: #0a0a0f;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 0 20px var(--accent-glow);
}
.btn:hover{
  transform: translateY(-1px);
  box-shadow: 0 4px 30px var(--accent-glow);
}
.btn.secondary{
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  color: var(--muted);
  box-shadow: none;
}
.btn.secondary:hover{
  background: rgba(255, 255, 255, 0.08);
  border-color: var(--accent);
  color: #fff;
  box-shadow: 0 0 20px var(--accent-glow);
}
.unread-dot{
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--accent);
  margin-left: 8px;
  flex-shrink: 0;
  box-shadow: 0 0 10px var(--accent-glow);
}
.inbox-panel{
  position: absolute;
  right: 18px;
  top: 56px;
  width: 360px;
  background: rgba(17, 17, 27, 0.5);
  backdrop-filter: blur(30px);
  -webkit-backdrop-filter: blur(30px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 14px;
  z-index: 1300;
  box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6);
}
.inbox-item{
  display: flex;
  flex-direction: column;
  padding: 12px;
  border-radius: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  cursor: pointer;
  transition: all 0.2s ease;
}
.inbox-item:hover{
  background: rgba(255, 255, 255, 0.05);
}
.inbox-item.unread{
  background: rgba(167, 139, 250, 0.08);
  border-left: 3px solid var(--accent);
}

#userProfileModal{
  position: fixed;
  inset: 0;
  background: rgba(10, 10, 15, 0.9);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  display: none;
}
.profile-card{
  background: rgba(17, 17, 27, 0.5);
  backdrop-filter: blur(40px);
  -webkit-backdrop-filter: blur(40px);
  border: 1px solid var(--glass-border);
  width: 420px;
  border-radius: 20px;
  padding: 32px;
  box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7);
  color: #f5f5f7;
  text-align: center;
}
.profile-pfp{
  width: 128px;
  height: 128px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid var(--accent);
  margin-bottom: 16px;
  box-shadow: 0 0 30px var(--accent-glow);
}
.profile-name{
  font-size: 26px;
  font-weight: 800;
  margin: 8px 0;
  color: var(--accent);
  text-shadow: 0 0 20px var(--accent-glow);
}
.profile-username{opacity:0.7;font-size:16px;margin-bottom:16px}
.profile-bio{
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  padding: 16px;
  border-radius: 12px;
  margin: 20px 0;
  min-height: 80px;
  font-size: 15px;
  line-height: 1.5;
  word-wrap: break-word;
}
.profile-actions{display:flex;gap:12px;margin-top:20px}
.profile-actions button{
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
}
.msg-btn{
  background: var(--accent);
  color: #0a0a0f;
  box-shadow: 0 0 20px var(--accent-glow);
}
.msg-btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 4px 30px var(--accent-glow);
}
.close-btn{
  background: rgba(255, 77, 77, 0.2);
  border: 1px solid rgba(255, 77, 77, 0.3);
  color: #ff4d4d;
}
.close-btn:hover{
  background: rgba(255, 77, 77, 0.3);
  box-shadow: 0 0 20px rgba(255, 77, 77, 0.3);
}

.clickable-user{
  color: var(--accent);
  cursor: pointer;
  transition: all 0.2s ease;
}
.clickable-user:hover{
  text-shadow: 0 0 10px var(--accent-glow);
}
</style>
</head>
<body>

<div class="navbar">
  <div class="brand">Epick Chat</div>
  <div class="nav-actions">
    <button id="inboxBtn" class="inbox-btn">Inbox <span id="inboxBadge" class="inbox-badge" style="display:none">0</span></button>
    <button id="accountBtn" class="btn secondary">Account</button>
    <button id="logoutBtn" class="btn secondary">Logout</button>
  </div>
</div>

<div id="userProfileModal">
  <div class="profile-card">
    <img id="upPfp" class="profile-pfp" src="/avatars/default.png">
    <div class="profile-name" id="upName">Loading...</div>
    <div class="profile-username" id="upUsername"></div>
    <div class="profile-bio" id="upBio">No bio set</div>
    <div class="profile-actions">
      <button class="msg-btn" id="msgBtn">Send Message</button>
      <button class="close-btn">Close</button>
    </div>
  </div>
</div>

<div id="inboxPanel" class="inbox-panel" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="font-weight:700">Inbox</div>
    <div><button id="markAllRead" class="btn secondary">Mark all read</button></div>
  </div>
  <div id="inboxList" style="max-height:340px;overflow:auto"></div>
  <div id="inboxEmpty" style="opacity:0.7;margin-top:8px">No notifications</div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="friends">Friends</div>
  <div class="tab" data-tab="rooms">Rooms</div>
  <div class="tab" data-tab="dms">DMs</div>
</div>

<main>
  <section id="friends" class="panel active">
    <h4 class="card-title">Recently Registered</h4>
    <div id="recentUsers" class="list"></div>
    <h4 class="card-title">Requests</h4>
    <div id="friendRequests" class="list"></div>
    <h4 class="card-title">Your Friends</h4>
    <div id="friendsList" class="list"></div>
  </section>

  <section id="rooms" class="panel">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="roomName" placeholder="Room name" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#fff">
      <button id="createRoomBtn" class="btn">Create Room</button>
    </div>
    <h4 class="card-title">Available Rooms</h4>
    <div id="roomsList" class="list"></div>
  </section>

  <section id="dms" class="panel">
    <h4 class="card-title">Direct Messages</h4>
    <div id="dmList" class="list"></div>
  </section>
</main>

<div id="chatOverlay" class="chat-overlay hidden">
  <div class="chat-window">
    <div class="chat-header">
      <div id="chatTitle" class="chat-title">Chat</div>
      <button id="closeChat" class="btn secondary">Close</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
      <input id="chatInput" maxlength="300" placeholder="Type a message (Enter to send)">
      <button id="sendBtn" class="btn">Send</button>
    </div>
  </div>
</div>

<script>
(async function(){
  const socket = io();
  let me = null, isAdmin = false, current = null;
  const unreadDMs = new Set();

  const inboxBtn = document.getElementById('inboxBtn');
  const inboxBadge = document.getElementById('inboxBadge');
  const inboxPanel = document.getElementById('inboxPanel');
  const inboxList = document.getElementById('inboxList');
  const inboxEmpty = document.getElementById('inboxEmpty');
  const markAllReadBtn = document.getElementById('markAllRead');
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.panel');
  const recentUsersDiv = document.getElementById('recentUsers');
  const friendRequestsDiv = document.getElementById('friendRequests');
  const friendsListDiv = document.getElementById('friendsList');
  const roomsListDiv = document.getElementById('roomsList');
  const dmListDiv = document.getElementById('dmList');
  const chatOverlay = document.getElementById('chatOverlay');
  const chatTitle = document.getElementById('chatTitle');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const closeChatBtn = document.getElementById('closeChat');

  const profileModal = document.getElementById('userProfileModal');
  const upPfp = document.getElementById('upPfp');
  const upName = document.getElementById('upName');
  const upUsername = document.getElementById('upUsername');
  const upBio = document.getElementById('upBio');
  const msgBtn = document.getElementById('msgBtn');
  let currentProfileUser = null;

  profileModal.querySelector('.close-btn').onclick = () => profileModal.style.display = 'none';
  profileModal.onclick = e => { if(e.target === profileModal) profileModal.style.display = 'none'; };

  function showBadge(n){ if(!n||n<=0){inboxBadge.style.display='none'}else{inboxBadge.style.display='';inboxBadge.textContent=String(n)} }

  inboxBtn.onclick = () => {
    const v = inboxPanel.style.display !== 'none';
    inboxPanel.style.display = v ? 'none' : '';
    if (!v) loadInbox();
  };

  markAllReadBtn.onclick = async() => {
    await fetch('/inbox/mark-read',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:'all'})});
    await loadInbox();
  };

  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    panels.forEach(p=>p.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
  }));

  document.getElementById('accountBtn').onclick = () => location.href = '/account.html';
  document.getElementById('logoutBtn').onclick = async() => {
    await fetch('/logout',{method:'POST'});
    location.href='/login.html';
  };

  async function api(p,o={}){ try{const r=await fetch(p,o);return await r.json();}catch(e){console.error(e);return null;} }

  async function init(){
    const meRes = await api('/me');
    if(!meRes||!meRes.loggedIn) return location.href='/login.html';
    me = meRes.username; isAdmin = !!meRes.admin;
    socket.emit('registerUser', me);
    await Promise.all([loadFriendsAndRecent(), loadRooms(), loadDMList()]);
    await loadInbox();
  }

  async function openUserProfile(username){
    if(username === me) return location.href = '/account.html';

    const friendsRes = await api('/friends');
    let user = null;

    if(friendsRes){
      const all = [...(friendsRes.friends||[]), ...(friendsRes.recent||[])];
      user = all.find(u => u.username === username);
    }

    if(!user){
      user = {
        username,
        avatar: "/avatars/default.png",
        displayName: username,
        bio: "No bio set"
      };
    }

    upPfp.src = user.avatar || "/avatars/default.png";
    upName.textContent = user.displayName || username;
    upUsername.textContent = "@" + username;
    upBio.textContent = user.bio || "No bio set";

    currentProfileUser = username;
    msgBtn.onclick = () => {
      profileModal.style.display = 'none';
      openDM(username);
    };

    profileModal.style.display = 'flex';
  }

  function makeUsernameClickable(username, element){
    element.innerHTML = '';
    const span = document.createElement('span');
    span.textContent = username;
    span.style.color = "#6b8cff";
    span.style.cursor = "pointer";
    span.onclick = e => { e.stopPropagation(); openUserProfile(username); };
    element.appendChild(span);
  }

  async function loadInbox(){
    const res = await api('/inbox');
    if(!res||!res.success){ inboxList.innerHTML=''; inboxEmpty.style.display=''; showBadge(0); return; }
    const notes = res.notifications||[];
    inboxList.innerHTML='';
    if(notes.length===0) inboxEmpty.style.display='';
    else inboxEmpty.style.display='none';
    let unread=0;
    notes.forEach(n=>{
      if(!n.read) unread++;
      const item=document.createElement('div'); item.className='inbox-item'+(n.read?'':' unread');
      item.innerHTML=`<div style="display:flex;justify-content:space-between"><div style="font-weight:600">${n.type}</div><div style="font-size:12px;color:var(--muted)">${formatDate(n.time)}</div></div><div style="margin-top:6px;color:var(--muted);font-size:13px">${renderNotifText(n)}</div>`;
      item.onclick=async()=>{ await fetch('/inbox/mark-read',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:n.id})});
        if(n.type==='dm'&&n.payload?.from) openDM(n.payload.from);
        if(n.type==='friend_request') { document.querySelector('.tab[data-tab="friends"]').click(); loadFriendsAndRecent(); }
        await loadInbox();
      };
      inboxList.appendChild(item);
    });
    showBadge(unread);
  }

  function renderNotifText(n){
    if(n.type==='dm') return `New DM from ${n.payload.from}`;
    if(n.type==='friend_request') return `Friend request from ${n.payload.from}`;
    if(n.type==='friend_accept') return `${n.payload.by} accepted your friend request`;
    if(n.type==='room_invite') return `${n.payload.by} invited you to ${n.payload.roomName}`;
    return JSON.stringify(n.payload||{});
  }

  socket.on('inboxUpdate',()=>{ if(inboxPanel.style.display!=='none')loadInbox(); else showBadge((parseInt(inboxBadge.textContent||'0')||0)+1); });

  async function loadFriendsAndRecent(){
    const data = await api('/friends'); if(!data) return;
    friendRequestsDiv.innerHTML=''; friendsListDiv.innerHTML=''; recentUsersDiv.innerHTML=''; dmListDiv.innerHTML='';

    (data.requests||[]).forEach(r=>{
      const el=document.createElement('div'); el.className='list-item';
      el.innerHTML=`<div>${r}</div><div><button class="btn secondary">Accept</button></div>`;
      el.querySelector('button').onclick=e=>{e.stopPropagation();fetch('/accept-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({from:r})}).then(()=>loadFriendsAndRecent());};
      friendRequestsDiv.appendChild(el);
    });

    (data.friends||[]).forEach(f=>{
      const friendEl=document.createElement('div'); friendEl.className='list-item';
      friendEl.innerHTML=`
        <div style="display:flex;align-items:center;gap:10px">
          <img src="${f.avatar||'/avatars/default.png'}" class="pfp">
          <div class="clickable-user">${f.username}</div>
        </div>
      `;
      friendEl.onclick = () => openUserProfile(f.username);
      friendsListDiv.appendChild(friendEl);

      const dmEl=document.createElement('div'); dmEl.className='list-item';
      dmEl.innerHTML=`
        <div style="display:flex;align-items:center;gap:12px">
          <img src="${f.avatar||'/avatars/default.png'}" class="pfp">
          <div class="clickable-user">@ ${f.username}</div>
          ${unreadDMs.has(f.username)?'<div class="unread-dot"></div>':''}
        </div>
      `;
      dmEl.onclick = () => openDM(f.username);
      dmListDiv.appendChild(dmEl);
    });

    (data.recent||[]).forEach(u=>{
      const el=document.createElement('div'); el.className='list-item';
      el.innerHTML=`
        <div style="display:flex;align-items:center;gap:10px">
          <img src="${u.avatar||'/avatars/default.png'}" class="pfp">
          <div class="clickable-user">${u.username}</div>
        </div>
        <div><button class="btn secondary">Add Friend</button></div>
      `;
      el.querySelector('button').onclick=e=>{e.stopPropagation();fetch('/friend-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:u.username})}).then(()=>loadFriendsAndRecent());};
      el.onclick = () => openUserProfile(u.username);
      recentUsersDiv.appendChild(el);
    });
  }

  async function loadRooms(){
    const data = await api('/rooms'); if(!data) return;
    roomsListDiv.innerHTML='';
    Object.entries(data).forEach(([id,r])=>{
      const el=document.createElement('div'); el.className='list-item';
      const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';
      const img=document.createElement('img'); img.className='room-pfp'; img.src=r.pfp||'/room_pfps/default.png';
      const meta=document.createElement('div');
      meta.innerHTML=`<div style="font-weight:700">${r.name}</div><div class="room-meta">${r.description||''}</div><div class="room-meta">owner: <span class="clickable-user">${r.owner||'—'}</span> · ${r.inviteOnly?'invite-only':'public'}</div>`;
      left.appendChild(img); left.appendChild(meta);
      const right=document.createElement('div');
      const joinBtn=document.createElement('button'); joinBtn.className='btn secondary'; joinBtn.textContent='Join';
      joinBtn.onclick=()=>openRoom(id,r.name);
      right.appendChild(joinBtn);
      if(r.owner===me||isAdmin){
        const manage=document.createElement('button'); manage.className='btn secondary'; manage.textContent='Manage';
        manage.onclick=e=>{e.stopPropagation();openRoomManageDialog(id,r);};
        right.appendChild(manage);
      }
      el.appendChild(left); el.appendChild(right);
      el.onclick=()=>openRoom(id,r.name);
      roomsListDiv.appendChild(el);
      meta.querySelector('.clickable-user').onclick=e=>{e.stopPropagation();openUserProfile(r.owner);};
    });
  }

  document.getElementById('createRoomBtn').onclick=async()=>{
    const name=document.getElementById('roomName').value.trim();
    if(!name) return alert('Enter a room name');
    const res=await fetch('/create-room',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
    const j=await res.json();
    if(j.success){ await loadRooms(); openRoom(j.roomId,name); } else alert(j.message||'Failed');
  };

  async function openRoomManageDialog(roomId,roomObj){
    const fresh=await api(`/room-info/${roomId}`);
    if(!fresh?.success) return alert("Failed to load room");
    const r=fresh;

    const options=['Rename room','Set description','Set privacy (public / invite)','Set posting permission (any / friends / owner)','Set pfp URL','Upload pfp file','Invite user','Ban user','Unban user'];
    const pick=prompt(`Manage "${r.name}"\n${options.map((o,i)=>`${i+1}) ${o}`).join('\n')}\nEnter number:`);
    if(!pick) return;
    const idx=Number(pick);
    if(isNaN(idx)||idx<1||idx>options.length) return;

    switch(idx){
      case 1: const n=prompt('New name:',r.name); if(n)await fetch('/room-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,action:'setName',value:n.trim()})});break;
      case 2: const d=prompt('Description:',r.description||''); if(d!==null)await fetch('/room-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,action:'setDescription',value:d})});break;
      case 3: const p=prompt('Privacy (public / invite):',r.inviteOnly?'invite':'public'); if(p)await fetch('/room-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,action:'setPrivacy',value:p})});break;
      case 4: const cp=prompt('Who can post? (any / friends / owner):',r.canPost||'any'); if(cp)await fetch('/room-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,action:'setCanPost',value:cp})});break;
      case 5: const u=prompt('PFP URL:'); if(u)await fetch('/room-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,action:'setPfp',value:u})});break;
      case 6: const i=document.createElement('input');i.type='file';i.accept='image/*';i.onchange=async()=>{if(!i.files[0])return;const f=new FormData();f.append('pfp',i.files[0]);f.append('roomId',roomId);await fetch('/update-room-pfp',{method:'POST',body:f});loadRooms();};i.click();return;
      case 7: const t=prompt('Username to invite:'); if(t)await fetch('/room-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,action:'invite',target:t})});break;
      case 8: const b=prompt('Username to ban:'); if(b)await fetch('/room-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,action:'ban',target:b})});break;
      case 9: const ub=prompt('Username to unban:'); if(ub)await fetch('/room-action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomId,action:'unban',target:ub})});break;
    }
    setTimeout(loadRooms,300);
  }

  function formatDate(ts){ const d=new Date(ts||Date.now()); const t=d.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'}); return `${t}, ${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`; }

  async function openRoom(id,name){
    current={type:'room',id,roomOwner:null};
    const info=await api(`/room-info/${id}`);
    chatTitle.innerHTML=`<img src="${(info?.pfp)||'/room_pfps/default.png'}" style="width:36px;height:36px;border-radius:8px;margin-right:8px"><span>${name}</span>`;
    if(info?.success) current.roomOwner=info.owner;
    chatMessages.innerHTML='';
    chatOverlay.classList.remove('hidden');
    socket.emit('joinRoom',{roomId:id});
  }

  async function openDM(username){
    current={type:'dm',id:username};
    chatTitle.innerHTML=`<img src="/avatars/default.png" style="width:36px;height:36px;border-radius:50%;margin-right:8px"><span>@ ${username}</span>`;
    chatMessages.innerHTML='';
    const r=await api(`/dm/${username}`);
    if(r?.success)(r.messages||[]).forEach(m=>appendMessage(m));
    chatOverlay.classList.remove('hidden');
    unreadDMs.delete(username);
    loadDMList();
  }

  function createMessageElement(m){
    const el=document.createElement('div'); el.className='chat-message'+(m.sender===me?' me':''); el.dataset.msgid=m.id;
    const av=document.createElement('img'); av.src=m.avatar||'/avatars/default.png'; av.className='pfp';
    const bubble=document.createElement('div'); bubble.className='bubble';

    const nameSpan=document.createElement('span');
    nameSpan.textContent=m.sender;
    nameSpan.style.color="#6b8cff";
    nameSpan.style.cursor="pointer";
    nameSpan.onclick=e=>{e.stopPropagation(); openUserProfile(m.sender);};

    const meta=document.createElement('div'); meta.className='meta';
    meta.appendChild(nameSpan);
    meta.innerHTML += ` • ${formatDate(m.time)}`;

    bubble.appendChild(meta);
    bubble.innerHTML += `<div style="margin-top:8px">${escapeHtml(m.message||'')}</div>`;

    let allowDelete=(m.sender===me)||isAdmin;
    if(current?.type==='room'&&current.roomOwner===me) allowDelete=true;
    if(allowDelete){
      const a=document.createElement('div'); a.className='actions';
      a.innerHTML=`<span data-act="edit">Edit</span><span data-act="delete">Delete</span>`;
      a.onclick=async e=>{
        if(e.target.dataset.act==='edit'){
          const nm=prompt('Edit:',m.message);
          if(nm!==null) await fetch('/edit-message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:m.id,newMsg:nm,dmWith:current?.type==='dm'?current.id:undefined,roomId:current?.type==='room'?current.id:undefined})});
        }
        if(e.target.dataset.act==='delete'&&confirm('Delete?')){
          await fetch('/delete-message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:m.id,dmWith:current?.type==='dm'?current.id:undefined,roomId:current?.type==='room'?current.id:undefined})});
          el.remove();
        }
      };
      bubble.appendChild(a);
    }
    el.appendChild(av); el.appendChild(bubble);
    return el;
  }

  function appendMessage(m){
    if(!m||!m.id) return;
    if(m.tempId){
      const opt=chatMessages.querySelector(`[data-msgid="${m.tempId}"]`);
      if(opt){
        opt.dataset.msgid=m.id;
        const b=opt.querySelector('.bubble');
        if(b) b.innerHTML=`<div class="meta">${m.sender} • ${formatDate(m.time)}</div><div style="margin-top:8px">${escapeHtml(m.message||'')}</div>`;
        const i=opt.querySelector('img.pfp'); if(i&&m.avatar) i.src=m.avatar;
        chatMessages.scrollTop=chatMessages.scrollHeight;
        return;
      }
    }
    if(document.querySelector(`[data-msgid="${m.id}"]`)) return;
    const el=createMessageElement(m);
    chatMessages.appendChild(el);
    chatMessages.scrollTop=chatMessages.scrollHeight;
  }

  async function sendMessage(){
    const txt=chatInput.value.trim();
    if(!txt) return;
    if(!current) return alert('Open a room or DM first');
    if(current.type==='room'){
      socket.emit('roomMessage',{roomId:current.id,message:txt});
    }else{
      const tempId='temp-'+Date.now()+'-'+Math.floor(Math.random()*1000);
      const temp={id:tempId,sender:me,avatar:null,message:txt,time:Date.now(),to:current.id};
      appendMessage(temp);
      socket.emit('dmMessage',{to:current.id,message:txt,tempId});
    }
    chatInput.value='';
  }

  sendBtn.onclick=sendMessage;
  chatInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage();});

  function closeChat(){
    if(current?.type==='room') socket.emit('leaveRoom',{roomId:current.id});
    current=null;
    chatOverlay.classList.add('hidden');
    chatMessages.innerHTML='';
  }
  closeChatBtn.onclick=closeChat;
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeChat();});
  chatOverlay.addEventListener('click',e=>{if(e.target===chatOverlay)closeChat();});

  socket.on('chatHistory',msgs=>{chatMessages.innerHTML='';(msgs||[]).forEach(m=>appendMessage(m));});
  socket.on('roomMessage',m=>{if(current?.type==='room'&&current.id===m.roomId)appendMessage(m);});
  socket.on('dmMessage',m=>{
    if(current?.type==='dm'&&(current.id===m.sender||current.id===m.to)) appendMessage(m);
    else{
      const o=(m.sender===me)?m.to:m.sender;
      unreadDMs.add(o);
      loadDMList();
      showBadge((parseInt(inboxBadge.textContent||'0')||0)+1);
    }
  });
  socket.on('friendsUpdate',()=>{loadFriendsAndRecent();loadDMList();});
  socket.on('roomsUpdated',()=>loadRooms());

  function escapeHtml(s){return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

  await init();
})();
</script>
</body>
</html>
