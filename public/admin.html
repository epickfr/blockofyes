<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Epick Chat - God Mode</title>
  <style>
    body { margin:0; padding:20px; font-family:system-ui; background:#0a0e17; color:#fff; min-height:100vh; }
    h1 { color:#6b8cff; text-align:center; margin-bottom:30px; }
    .card { background:rgba(255,255,255,0.04); border-radius:12px; padding:20px; margin-bottom:20px; }
    .user, .room { 
      display:flex; justify-content:space-between; align-items:center; 
      padding:12px; margin:8px 0; background:rgba(255,255,255,0.03); border-radius:8px;
    }
    button { 
      padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;
      background:#ff4444; color:white; margin-left:8px;
    }
    button.unban { background:#00aa00; }
    button:hover { opacity:0.9; }
    .danger { background:#ff2222 !important; width:100%; padding:15px; font-size:16px; margin-top:20px; }
    .back { position:fixed; top:20px; right:20px; background:#6b8cff; color:black; padding:10px 16px; border-radius:8px; text-decoration:none; font-weight:bold; }
  </style>
</head>
<body>
  <a href="/" class="back">Back to Chat</a>
  <h1>Epick Chat — GOD MODE</h1>

  <div class="card">
    <h2>Users</h2>
    <div id="users"></div>
  </div>

  <div class="card">
    <h2>Rooms</h2>
    <div id="rooms"></div>
  </div>

  <div class="card">
    <h2>Danger Zone</h2>
    <button class="danger" onclick="nukeMessages()">NUKE ALL MESSAGES</button>
    <button class="danger" onclick="wipeServer()">WIPE ENTIRE SERVER (No Undo)</button>
  </div>

  <script>
    // Works with your current server — no changes needed!
    async function api(path, opts = {}) {
      const res = await fetch(path, {
        method: opts.method || "GET",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      if (!res.ok) throw new Error("Failed");
      return res.json();
    }

    async function checkAdmin() {
      try {
        const me = await api("/me");
        if (!me.admin) {
          alert("Only admins can use this panel!");
          location.href = "/";
          return false;
        }
        loadUsers();
        loadRooms();
        return true;
      } catch { location.href = "/login.html"; }
    }

    async function loadUsers() {
      const allUsers = {};
      // Pull from /friends + /rooms to get every username that exists
      try {
        const friends = await api("/friends");
        friends.friends?.forEach(f => allUsers[f.username] = { username: f.username });
        friends.requests?.forEach(r => allUsers[r] = { username: r });
        friends.recent?.forEach(u => allUsers[u.username] = { username: u.username });
      } catch(e) {}

      const usersDiv = document.getElementById("users");
      usersDiv.innerHTML = "";
      
      for (const username of Object.keys(allUsers)) {
        const div = document.createElement("div");
        div.className = "user";
        div.innerHTML = `
          <strong>${username}</strong>
          <div>
            <button onclick="ban('${username}')">Ban</button>
            <button class="unban" onclick="unban('${username}')">Unban</button>
          </div>
        `;
        usersDiv.appendChild(div);
      }
    }

    async function loadRooms() {
      const rooms = await api("/rooms");
      const roomsDiv = document.getElementById("rooms");
      roomsDiv.innerHTML = "";
      
      Object.entries(rooms).forEach(([id, room]) => {
        const div = document.createElement("div");
        div.className = "room";
        div.innerHTML = `
          <div>
            <strong>${room.name || "Unnamed Room"}</strong><br>
            <small>Owner: ${room.owner || "unknown"}</small>
          </div>
          <button onclick="deleteRoom('${id}')">Delete Room</button>
        `;
        roomsDiv.appendChild(div);
      });
    }

    window.ban = async (u) => { if(confirm(`Ban ${u} forever?`)) await api("/admin/ban", {method:"POST", body:{user:u}}); loadUsers(); };
    window.unban = async (u) => { await api("/admin/unban", {method:"POST", body:{user:u}}); loadUsers(); };
    window.deleteRoom = async (id) => { if(confirm("Delete this room forever?")) await api("/admin/delete-room", {method:"POST", body:{roomId:id}}); loadRooms(); };
    window.nukeMessages = async () => { if(prompt('Type "NUKE"') === "NUKE") await api("/admin/nuke-messages", {method:"POST"}); alert("All messages gone!"); };
    window.wipeServer = async () => { if(prompt('Type "WIPE SERVER"') === "WIPE SERVER") await api("/admin/wipe", {method:"POST"}); alert("Server wiped. Bye!"); setTimeout(()=>location.href="/",2000); };

    checkAdmin();
  </script>
</body>
</html>
